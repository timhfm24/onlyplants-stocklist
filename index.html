<script>
const q = (id)=>document.getElementById(id);
const grid = q('grid');
document.getElementById('year').textContent = new Date().getFullYear();
let allPlants = [];

// Pflanzen aus JSON laden und anzeigen
fetch('plants.json', { cache: 'no-store' })
  .then(r => r.json())
  .then(data => {
    // Status standardmäßig auf "verfügbar" setzen, falls keiner vorhanden ist
    allPlants = data.map(p => ({
      ...p,
      state: p.state && p.state.trim() !== '' ? p.state : 'verfügbar'
    }));
    setCategoryOptions(allPlants);
    render(allPlants);
  })
  .catch(err => {
    grid.innerHTML = '<div>Fehler beim Laden der Stocklist.</div>';
    console.error(err);
  });

function setCategoryOptions(plants) {
  const typeFilter = q('typeFilter');
  const categories = Array.from(new Set(plants.map(p => p.category)));
  typeFilter.innerHTML = '<option value="">Typ: Alle</option>' +
    categories.map(cat => `<option value="${cat}">${cat.charAt(0).toUpperCase() + cat.slice(1)}</option>`).join('');
}

function render(plants) {
  grid.innerHTML = plants.map(p => plantListItem(p)).join('');
}

function plantListItem(p) {
  let type = p.category;
  const typeLabel = type.charAt(0).toUpperCase() + type.slice(1);
  const status = p.state;
  const price = p.preis ? p.preis.toFixed(2) + ' €' : '';
  
  // Tag-Klasse je nach Status
  let tagClass = 'ok';
  if(status === 'reserviert') tagClass = 'warn';
  if(status === 'nicht verfügbar') tagClass = 'sold';
  
  return `<li class="plant-item" data-name="${escapeHTML(p.name)}" data-type="${type}" data-status="${status}">
    <div>
      <strong>${escapeHTML(p.name)}</strong>
      <div class="meta">${typeLabel}</div>
    </div>
    <span class="price">${price}</span>
    <span class="tag ${tagClass}">${status}</span>
  </li>`;
}

function escapeHTML(s){
  return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
}

function filter(){
  const t = q('typeFilter').value;
  const st = q('statusFilter').value;
  const filtered = allPlants.filter(p =>
    (!t || p.category === t) && (!st || p.state === st)
  );
  render(filtered);
}
</script>
